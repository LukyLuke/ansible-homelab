---

- name: Bootstrap all Hosts
  hosts: dns
  become: true
  gather_facts: false
  roles:
    - role: robertdebock.bootstrap

- name: dnsmaq installation and configuration
  hosts: dns
  become: true
  gather_facts: true
  roles:
    - role: robertdebock.dnsmasq

- name: Caddy Web-Proxy
  hosts: dns
  become: true
  gather_facts: true
  roles:
    - role: maxhoesel.caddy.caddy_server
      caddy_config_mode: Caddyfile
      caddy_caddyfile: |
        {
          email caddy-homelab@ranta.ch
          servers {
            metrics
          }
        }
        lukylab.duckdns.org,
        lab.ranta.ch {
          header Content-Type text/html
          respond <<HTML
            <html><head><title>LukyLAB</title></head>
            <body><h1>Luky LAB</h1></body>
            </html>
            HTML 200
        }
        # No route from inside the PVE-Container to the PVE-Host
        #lab.ranta.local {
        #  tls internal
        #  reverse_proxy https://192.168.88.5:8006 {
        #    header_down Strict-Transport-Security "max-age=31536000; includeSubdomains;"
        #    header_down Content-Security-Policy "default-src 'self' data: https: 'unsafe-inline'"
        #  }
        #}
        ansible.ranta.local {
          tls internal
          reverse_proxy http://192.168.88.6:3000 {
            header_down Strict-Transport-Security "max-age=31536000; includeSubdomains;"
            header_down Content-Security-Policy "default-src 'self' data: https: 'unsafe-inline'"
          }
        }
        cloud.ranta.ch,
        cloud.lab.ranta.ch {
          reverse_proxy http://192.168.88.10:80 {
            header_down Strict-Transport-Security "max-age=31536000; includeSubdomains;"
          }
        }

